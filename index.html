<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coliber â€” Connected</title>
<style>
  /* Ø³Ø¨Ú©Ù Ø¬Ù…Ø¹ Ùˆ Ø¬ÙˆØ±ØŒ ØªÙ… ØªÛŒØ±Ù‡ Ù†Ø¦ÙˆÙ†ÛŒ */
  body{margin:0;background:linear-gradient(180deg,#0b1117,#071021);font-family:'Vazirmatn',sans-serif;color:#e6f0ff;display:flex;flex-direction:column;height:100vh}
  .app{max-width:880px;margin:20px auto;flex:1;display:flex;flex-direction:column;gap:12px;padding:16px}
  .panel{background:rgba(255,255,255,0.03);border-radius:12px;padding:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6)}
  #chat{height:62vh;overflow:auto;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(4,6,12,0.3))}
  .msg{display:block;padding:10px 14px;margin:10px 0;border-radius:12px;max-width:78%}
  .user{margin-left:auto;background:linear-gradient(90deg,#022b3a,#03506f);box-shadow:0 6px 20px rgba(2,43,58,0.25)}
  .bot{margin-right:auto;background:linear-gradient(90deg,#1b1f3a,#3b2b6f);box-shadow:0 6px 20px rgba(59,43,111,0.12)}
  #controls{display:flex;gap:8px;align-items:center}
  input[type="text"], input[type="password"]{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.25);color:inherit}
  button{padding:10px 14px;border-radius:10px;border:none;background:#00eaff;color:#022;cursor:pointer}
  .muted{opacity:0.7;font-size:13px}
  .small{font-size:13px;color:#bcd}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .kbd{background:#00121a;padding:6px 8px;border-radius:8px;font-weight:600}
</style>
</head>
<body>
  <div class="app">
    <div class="panel topbar">
      <div>
        <strong>Coliber</strong>
        <div class="small muted">Ù‡ÙˆØ´ Ù…ØªØµÙ„ Ø¨Ù‡ ChatGPT â€” Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ùˆ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="setKeyBtn">Set API Key</button>
        <div class="kbd" id="status">API: âŒ</div>
      </div>
    </div>

    <div class="panel" id="chat" role="log" aria-live="polite"></div>

    <div class="panel" id="controls">
      <input id="input" type="text" placeholder="Ù‡Ø± Ú†ÛŒØ²ÛŒ Ø¨Ù¾Ø±Ø³ ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³..." />
      <button id="send">Ø§Ø±Ø³Ø§Ù„</button>
      <button id="teach">ÛŒØ§Ø¯ Ø¨Ú¯ÛŒØ±</button>
    </div>

    <div class="small muted">Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¹Ù…ÙˆÙ…ÛŒ Ø§Ø² Ø§ÛŒÙ† ØµÙØ­Ù‡ØŒ Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø³Ø±ÙˆØ± ÙˆØ§Ø³Ø· (Node.js) Ø¨Ú©Ø§Ø± Ø¨Ø¨Ø±ÛŒ ØªØ§ Ú©Ù„ÛŒØ¯ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø§ÙØ´Ø§ Ù†Ø´ÙˆØ¯.</div>
  </div>

<script>
/*
  Coliber connected â€” single-file client-side implementation.
  - Enter your OpenAI API key via "Set API Key" (stored in localStorage)
  - Coliber checks local memory first; if missing, asks ChatGPT automatically
  - Saves new answers into local memory for future
  - WARNING: exposing API key in browser is insecure for public sites.
*/

const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('send');
const teachBtn = document.getElementById('teach');
const setKeyBtn = document.getElementById('setKeyBtn');
const statusEl = document.getElementById('status');

let memory = JSON.parse(localStorage.getItem('coliber_memory_v1')||'{}');

// load API key from localStorage (user must set)
let API_KEY = localStorage.getItem('coliber_api_key') || null;
updateStatus();

// helper UI
function addMessage(text, who='bot'){
  const div = document.createElement('div');
  div.className = 'msg ' + (who==='user' ? 'user' : 'bot');
  div.innerText = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

// set API key flow (masked input)
setKeyBtn.onclick = ()=>{
  const k = prompt('Ú©Ù„ÛŒØ¯ API Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ø§Ù…Ù† Ù†Ú¯Ù‡ Ø¯Ø§Ø±). Ø§Ú¯Ø± Ù†Ù…ÛŒâ€ŒØ¯ÙˆÙ†ÛŒ Ú†ÛŒÙ‡ØŒ Ù…Ø±Ø§Ø­Ù„ Ø±Ùˆ Ø§Ø² OpenAI Ø¨Ú¯ÛŒØ±.');
  if(k && k.trim().length>10){
    API_KEY = k.trim();
    localStorage.setItem('coliber_api_key', API_KEY);
    updateStatus();
    alert('Ú©Ù„ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ Ø¯Ø± localStorage (ÙÙ‚Ø· Ø±ÙˆÛŒ Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡).');
  }
};

function updateStatus(){
  statusEl.innerText = API_KEY ? 'API: âœ…' : 'API: âŒ';
}

// teach button: "ÛŒØ§Ø¯ Ø¨Ú¯ÛŒØ± Ø¹Ø¨Ø§Ø±Øª = Ù¾Ø§Ø³Ø®"
teachBtn.onclick = ()=>{
  const txt = inputEl.value.trim();
  if(!txt){ inputEl.focus(); return; }
  // format: X = Y
  const parts = txt.split('=');
  if(parts.length>=2){
    const key = parts[0].trim();
    const val = parts.slice(1).join('=').trim();
    memory[key] = val;
    localStorage.setItem('coliber_memory_v1', JSON.stringify(memory));
    addMessage(`ÛŒØ§Ø¯ Ú¯Ø±ÙØªÙ…: Â«${key}Â» => Â«${val}Â»`, 'bot');
    inputEl.value = '';
  } else {
    addMessage('ÙØ±Ù…Øª ØµØ­ÛŒØ­: Ø¹Ø¨Ø§Ø±Øª = Ù…Ø¹Ù†ÛŒ ÛŒØ§ Ù¾Ø§Ø³Ø®', 'bot');
  }
};

// main send flow
sendBtn.onclick = async ()=>{
  const text = inputEl.value.trim();
  if(!text) return;
  addMessage(text, 'user'); inputEl.value = '';

  // 1) greeting detection (fast local)
  if(/^(Ø³Ù„Ø§Ù…|Ø¯Ø±ÙˆØ¯|hi|hello|Ú†Ø·ÙˆØ±ÛŒ|Ø­Ø§Ù„Øª)/i.test(text)){
    const replies = [
      'Ø³Ù„Ø§Ù…! Ø­Ø§Ù„Øª Ú†Ø·ÙˆØ±Ù‡ØŸ ğŸ˜Š',
      'Ø³Ù„Ø§Ù… Ø±ÙÛŒÙ‚! Ø§Ù…Ø±ÙˆØ² Ú†Ø·ÙˆØ±ÛŒØŸ âœ¨',
      'Ø¯Ø±ÙˆØ¯! Ú†Ù‡ Ø®Ø¨Ø±Ù‡ØŸ ğŸ˜',
      'Ø³Ù„Ø§Ù…! Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù… Ú©Ù‡ Ú©Ù…Ú© Ú©Ù†Ù… ğŸ”¥'
    ];
    addMessage(replies[Math.floor(Math.random()*replies.length)], 'bot');
    return;
  }

  // 2) exact memory match (key contains input)
  const keyFound = findMemoryKey(text);
  if(keyFound){
    addMessage(memory[keyFound], 'bot');
    return;
  }

  // 3) meaning request detection
  if(/Ù…Ø¹Ù†ÛŒ|ÛŒØ¹Ù†ÛŒ|Ú†ÛŒØ³Øª|Ú†ÛŒ Ù…ÛŒØ´Ù‡/i.test(text)){
    // ask chatgpt if available; otherwise ask user to teach
    if(API_KEY) {
      addMessage('â³ Ø¯Ø§Ø±Ù… Ø§Ø² Ù…Ù†Ø¨Ø¹ Ù…ÛŒâ€ŒÙ¾Ø±Ø³Ù…...', 'bot');
      const ans = await askChatGPT(text);
      if(ans){
        addMessage(ans, 'bot');
        // auto-save short Qâ†’A pair for future (only when reasonable)
        memory[text] = ans;
        localStorage.setItem('coliber_memory_v1', JSON.stringify(memory));
        return;
      }
    } else {
      addMessage('âš ï¸ Ù…Ù† Ø§ÛŒÙ†Ùˆ Ø¨Ù„Ø¯ Ù†ÛŒØ³ØªÙ… â€” ÙˆÙ„ÛŒ ØªÙˆ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ù…Ø¹Ù†ÛŒØ´Ùˆ Ø¨Ù‡Ù… Ø¨Ú¯ÛŒ ØªØ§ ÛŒØ§Ø¯ Ø¨Ú¯ÛŒØ±Ù… ğŸš€', 'bot');
      return;
    }
  }

  // 4) default: ask ChatGPT if API available, else say learned fallback
  if(API_KEY){
    addMessage('â³ Ø¯Ø§Ø±Ù… Ø§Ø² ChatGPT Ù…ÛŒâ€ŒÙ¾Ø±Ø³Ù… Ùˆ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù…...', 'bot');
    const ans = await askChatGPT(text);
    if(ans){
      addMessage(ans, 'bot');
      memory[text] = ans;
      localStorage.setItem('coliber_memory_v1', JSON.stringify(memory));
      return;
    } else {
      addMessage('âš ï¸ Ù…Ù† Ø§ÛŒÙ†Ùˆ Ù‡Ù†ÙˆØ² ÛŒØ§Ø¯ Ù†Ú¯Ø±ÙØªÙ…! Ù„Ø·ÙØ§Ù‹ Ù…Ø¹Ù†ÛŒØ´Ùˆ Ø¨Ù‡Ù… Ø¨Ú¯Ùˆ ğŸš€', 'bot');
      return;
    }
  } else {
    addMessage('âš ï¸ Ù…Ù† Ø§ÛŒÙ†Ùˆ Ù‡Ù†ÙˆØ² ÛŒØ§Ø¯ Ù†Ú¯Ø±ÙØªÙ…! Ù„Ø·ÙØ§Ù‹ Ù…Ø¹Ù†ÛŒØ´Ùˆ Ø¨Ù‡Ù… Ø¨Ú¯Ùˆ ğŸš€', 'bot');
  }
};

// find memory key by fuzzy contains (improved)
function findMemoryKey(input){
  const q = input.toLowerCase();
  // exact key
  for(const k of Object.keys(memory)){
    if(k.toLowerCase() === q) return k;
  }
  // contains
  for(const k of Object.keys(memory)){
    if(q.includes(k.toLowerCase())) return k;
  }
  // reverse contains (user asked a phrase that includes key)
  for(const k of Object.keys(memory)){
    if(k.toLowerCase().includes(q)) return k;
  }
  return null;
}

// call OpenAI Chat Completions (client-side). WARNING: key exposure risk.
async function askChatGPT(userPrompt){
  try{
    const payload = {
      model: 'gpt-3.5-turbo',
      messages: [
        {role:'system', content:'ØªÙˆ Coliber Ù‡Ø³ØªÛŒØ› Ø¬ÙˆØ§Ø¨â€ŒÙ‡Ø§ Ø±Ø§ Ø³Ø§Ø¯Ù‡ØŒ ÙˆØ§Ø¶Ø­ Ùˆ ÙØ§Ø±Ø³ÛŒ Ø¨Ø¯Ù‡Ø› Ø§Ú¯Ø± Ø³ÙˆØ§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ù†Ø§ÛŒ Ú©Ù„Ù…Ù‡ Ø§Ø³ØªØŒ Ù¾Ø§Ø³Ø® Ø±Ø§ Ú©ÙˆØªØ§Ù‡ Ùˆ Ù…Ø«Ø§Ù„â€ŒØ¯Ø§Ø± Ø¨Ø¯Ù‡.'},
        {role:'user', content: userPrompt}
      ],
      max_tokens: 700,
      temperature: 0.2
    };
    const res = await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization': 'Bearer ' + API_KEY
      },
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      console.error('OpenAI error', res.status);
      return null;
    }
    const j = await res.json();
    const content = j.choices && j.choices[0] && j.choices[0].message && j.choices[0].message.content;
    return content ? content.trim() : null;
  }catch(e){
    console.error(e);
    return null;
  }
}

// handy: press Enter to send
inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ sendBtn.click(); } });

/* INITIAL GREETING */
addMessage('Ø³Ù„Ø§Ù…! Ù…Ù† Coliber Ù‡Ø³ØªÙ… â€” Ø§Ú¯Ù‡ Ø¨Ø®ÙˆØ§ÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø®ÙˆØ¯Ù… Ø§Ø² ChatGPT Ø¨Ù¾Ø±Ø³Ù… Ùˆ Ø¬ÙˆØ§Ø¨ Ø±Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†Ù…. Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ØŒ Ø¯Ú©Ù…Ù‡ "Set API Key" Ø±Ùˆ Ø¨Ø²Ù†.', 'bot');
</script>
</body>
</html>
