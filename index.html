<script>
const SERVER_URL = 'http://localhost:3000/ask'; 
const chat = document.getElementById('chat');
const inp = document.getElementById('inp');

function addMsg(txt,cls,typing=false){
  const d=document.createElement('div');
  d.className='msg '+cls;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;

  // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø±Ø´
  if (txt.length > 3000) txt = txt.slice(0, 3000) + " ...";

  if(!typing){
    d.innerText=txt;
    d.classList.add('show');
    return;
  }

  let i=0;
  const showNext=()=>{
    if(i < txt.length){
      d.innerText=txt.slice(0, i);
      i+=3;
      chat.scrollTop=chat.scrollHeight;
      requestAnimationFrame(showNext);
    } else {
      d.classList.add('show');
    }
  };
  showNext();
}

function showTypingIndicator(){
  const t=document.createElement('div');
  t.className='msg bot typing';
  t.innerHTML='<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
  chat.appendChild(t);
  chat.scrollTop=chat.scrollHeight;
  return t;
}

// Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Crash Ú¯ÙØªØ§Ø±ÛŒ
function speak(text){
  try{
    if(!('speechSynthesis' in window)) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'fa-IR';
    utter.pitch = 1;
    utter.rate = 1;
    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
  }catch{
    console.warn("speech failed");
  }
}

async function sendMsg(){
  const val = inp.value.trim(); 
  if(!val) return;

  addMsg(val,'user');
  inp.value='';

  const typingNode = showTypingIndicator();

  try{
    const res = await fetch(SERVER_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({message:val})
    });

    let data;
    try{
      data = await res.json();
    }catch{
      throw new Error("JSON parse error");
    }

    if(typingNode && typingNode.parentNode) typingNode.remove();

    let answer = data.answer || 'âš ï¸ Ù¾Ø§Ø³Ø® Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª';

    // Ø¶Ø¯ ØªÚ©Ø±Ø§Ø±
    if (answer.trim() === val.trim()){
      answer = "Ø¨Ø§Ø´Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯! ÙˆÙ„ÛŒ ØªÚ©Ø±Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ù…. Ø¨Ú¯Ùˆ Ú†ÛŒ Ù…ÛŒØ®ÙˆØ§ÛŒ â¤ï¸";
    }

    addMsg(answer,'bot',true);
    speak(answer);

  }catch(e){
    console.error(e);
    if(typingNode && typingNode.parentNode) typingNode.remove();
    addMsg('âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· â€“ ØµÙØ­Ù‡ ÙØ±ÛŒØ² Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.','bot');
  }
}

document.getElementById('send').onclick=sendMsg;
inp.addEventListener('keydown',e=>{ if(e.key==='Enter') sendMsg(); });

addMsg('Ø³Ù„Ø§Ù…! Ù…Ù† Coliber Ù‡Ø³ØªÙ… ðŸŒŸ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù… Ù‡Ø±Ú†ÛŒ Ø®ÙˆØ§Ø³ØªÛŒ Ø¨Ù¾Ø±Ø³ÛŒ.','bot');
</script>
